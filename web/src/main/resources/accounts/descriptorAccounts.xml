<?xml version="1.0" encoding="UTF-8"?>

<zkib-model>
	<datanode name="root">
		<finder name="query" type="query">
			<script-finder>
				import es.caib.seycon.ng.comu.*;
				q = new AccountCriteria ();
				q.setExcludeType ( AccountType.USER);
				return q;
			</script-finder>
		</finder>
		<finder name="type" type="type">
			<script-finder>
				import es.caib.seycon.ng.comu.*;
				list = new java.util.LinkedList();
				list.add (new String(""));
				for (l: AccountType.literals())
				{
					list.add (l);
				}
				return list;
			</script-finder>
		</finder>
		<finder name="dispatcher" type="dispatcher">
			<script-finder>
				es.caib.seycon.ng.comu.Dispatcher dis = new es.caib.seycon.ng.comu.Dispatcher();
				return dis;
			</script-finder>
			<ejb-finder jndi="java:comp/env/ejb/DispatcherEJB" method="findDispatchersByFiltre">
				<parameter value="${null}" />
				<parameter value="${null}" />
				<parameter value="${null}" />
				<parameter value="${null}" />
				<parameter value="${null}" />
				<parameter value="${null}" />
			</ejb-finder>
		</finder>
		<finder name="account" type="account">
			<ejb-finder jndi="openejb:/local/soffid.ejb.es.caib.seycon.ng.servei.AccountService"
				method="findAccountsByCriteria" if="${queryEnabled}"> <!--agent:query, application:update -->
				<parameter value="${self.query[0].instance}" />
			</ejb-finder>
			<new-instance-script>
				bean = new es.caib.seycon.ng.comu.Account();
				bean.setType(es.caib.seycon.ng.comu.AccountType.IGNORED);
				bean.setGrantedUsers ( new LinkedList()) ;
				bean.setGrantedRoles (new LinkedList());
				bean.setGrantedGroups (new LinkedList());
				bean.setManagerUsers ( new LinkedList()) ;
				bean.setManagerRoles (new LinkedList());
				bean.setManagerGroups (new LinkedList());
				bean.setOwnerUsers ( new LinkedList()) ;
				bean.setOwnerRoles (new LinkedList());
				bean.setOwnerGroups (new LinkedList());
				bean.setStatus(com.soffid.iam.api.AccountStatus.ACTIVE);
				return bean;
			</new-instance-script>
			<ejb-finder jndi="openejb:/local/soffid.ejb.es.caib.seycon.ng.servei.AccountService"
					method="findAccountByJsonQueryAsync" if="${query != null  &amp;&amp; synchro == null}">
				<parameter value="${query}"/>
			</ejb-finder>
			<ejb-finder jndi="openejb:/local/soffid.ejb.es.caib.seycon.ng.servei.AccountService"
					method="findAccountByJsonQuery" if="${query != null  &amp;&amp; synchro != null}">
				<parameter value="${query}"/>
			</ejb-finder>
		</finder>
		<finder name="tipusUsuari" type="tipusUsuari">
			<script-finder>
				obj = new es.caib.seycon.ng.comu.TipusUsuari();
				obj.descripcio = " - Select user type - ";
				return obj;
			</script-finder>
			<ejb-finder jndi="java:comp/env/ejb/DominiUsuariEJB" method="findAllTipusUsuari">
			</ejb-finder>
		</finder>		
		<finder name="folder" type="folder"> <!-- intranetMenus:query -->
			<ejb-finder jndi="java:comp/env/ejb/VaultServiceEJB"
				 method="findFolders" >
				<parameter value="${null}" />
			</ejb-finder>
		</finder>
	</datanode>

	<datanode name="query" transient="true" />

	<datanode name="folder" transient="true" >
		<finder name="folder" type="folder">  <!-- intranetMenus:query -->
			<ejb-finder jndi="java:comp/env/ejb/VaultServiceEJB"
				method="getChildren">
				<parameter value="${instance}" />
			</ejb-finder>
		</finder>
	</datanode>

	<datanode name="type" transient="true">
		<custom-attribute name="literal">
			if (instance.length() == 0)
				return "";
			else
				return org.zkoss.util.resource.Labels.getLabel("accountType."+instance);
		</custom-attribute>
		<custom-attribute name="value">
			if (instance.length() == 0)
				return null;
			else
				return es.caib.seycon.ng.comu.AccountType.fromString(instance);
		</custom-attribute>

	</datanode>
	
	<datanode name="dispatcher" transient="true"/>
	
	<datanode name="account">
		<ejb-handler jndi="openejb:/local/soffid.ejb.es.caib.seycon.ng.servei.AccountService">
			<insert-method method="createAccount2" returnBean="true" >  <!-- user:create -->
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="removeAccount">    
				<parameter value="${instance}" />
			</delete-method>
			<update-method method="updateAccount2" returnBean="true"> <!-- user:update -->
				<parameter value="${instance}" />
			</update-method>
		
		</ejb-handler>
		<finder name="rol" type="rol" refreshAfterCommit="true"> <!-- user:role:query -->
			<ejb-finder jndi="java:comp/env/ejb/AplicacioEJB"
				method="findRolAccountByAccount">
				<parameter value="${instance.id}"/>
			</ejb-finder>
			<new-instance-bean className="es.caib.seycon.ng.comu.RolAccount"> 
			</new-instance-bean>
		</finder>
		<finder name="rolsheredats" type="rolheredat"> <!-- user:role:query -->
			<ejb-finder jndi="java:comp/env/ejb/AplicacioEJB"
				method="findEffectiveRolGrantByAccount">
				<parameter value="${instance.id}"/>
			</ejb-finder>
		</finder>
		<finder name="grantedUsers" type ="grantedUser" refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.grantedUsers}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Usuari"> 
			</new-instance-bean>
		</finder>
		<finder name="grantedGroups" type ="grantedGroup"  refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.grantedGroups}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Grup"> 
			</new-instance-bean>
		</finder>
		<finder name="grantedRoles" type ="grantedRole"  refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.grantedRoles}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Rol"> 
			</new-instance-bean>
		</finder>

		<finder name="ownerUsers" type ="ownerUser"  refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.ownerUsers}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Usuari"> 
			</new-instance-bean>
		</finder>
		<finder name="ownerGroups" type ="ownerGroup"  refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.ownerGroups}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Grup"> 
			</new-instance-bean>
		</finder>
		<finder name="ownerRoles" type ="ownerRole"  refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.ownerRoles}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Rol"> 
			</new-instance-bean>
		</finder>

		<finder name="managerUsers" type ="managerUser"  refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.managerUsers}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Usuari"> 
			</new-instance-bean>
		</finder>
		<finder name="managerGroups" type ="managerGroup" refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.managerGroups}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Grup"> 
			</new-instance-bean>
		</finder>
		<finder name="managerRoles" type ="managerRole" refreshAfterCommit="true" updateAfterParent="false">
			<collection-finder collection="${instance.managerRoles}"/>
			<new-instance-bean className="es.caib.seycon.ng.comu.Rol"> 
			</new-instance-bean>
		</finder>
		<finder name="services" type ="service">
			<ejb-finder jndi="openejb:/local/soffid.ejb.es.caib.seycon.ng.servei.AccountService"
				method="findAccountServices">
				<parameter value="${instance}"/>
			</ejb-finder>
		</finder>
		<finder name="events" type="event" refreshAfterCommit="true"> <!-- user:role:query -->
			<ejb-finder jndi="java:/module/AuditService-v2"
				method="findAuditByJsonQueryAsync" >
				<parameter value="searchIndex eq 'ACC#${instance.id}'"/>
			</ejb-finder>
		</finder>
		
		<validator>
			<attribute-validator expr="${instance.name}" notNull="true" friendlyName="accounts.nameValidation"/>
			<attribute-validator expr="${instance.dispatcher}" notNull="true" friendlyName="accounts.dispatcherValidation"/>
			<attribute-validator expr="${instance.passwordPolicy}" notNull="true" friendlyName="accounts.passwordPolicyValidation"/>
		</validator>
	</datanode>

	<datanode name="event" transient="true" />
	
	<datanode name="service" transient="true">
	</datanode>
	
	<datanode name="grantedUser">
		<collection-handler collection="${self.instance.grantedUsers}"/>
	</datanode>
	
	<datanode name="grantedRole">
		<collection-handler collection="${self.instance.grantedRoles}"/>
	</datanode>

	<datanode name="grantedGroup">
		<collection-handler collection="${self.instance.grantedGroups}"/>
	</datanode>

	<datanode name="ownerUser">
		<collection-handler collection="${self.instance.ownerUsers}"/>
	</datanode>
	
	<datanode name="ownerRole">
		<collection-handler collection="${self.instance.ownerRoles}"/>
	</datanode>

	<datanode name="ownerGroup">
		<collection-handler collection="${self.instance.ownerGroups}"/>
	</datanode>

	<datanode name="managerUser">
		<collection-handler collection="${self.instance.managerUsers}"/>
	</datanode>
	
	<datanode name="managerRole">
		<collection-handler collection="${self.instance.managerRoles}"/>
	</datanode>

	<datanode name="managerGroup">
		<collection-handler collection="${self.instance.managerGroups}"/>
	</datanode>

	<datanode name="rol">
		<ejb-handler jndi="java:comp/env/ejb/AplicacioEJB">
			<insert-method method="create" returnBean="true" > <!-- user:role:create -->
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete" >  <!-- user:role:delete -->
				<parameter value="${instance}" />
			</delete-method>
			<!--update-method method="update"> // en principi no s'utilitza 
				<parameter value="${instance}" />
			</update-method-->
		</ejb-handler>
	</datanode>
	
	<datanode name="rolheredat">
		<custom-attribute name="origin">
			if (instance.ownerAccountName != null)
				return String.format(org.zkoss.util.resource.Labels.getLabel("accounts.fromAccount"),
					new Object[]{instance.ownerAccountName, instance.ownerDispatcher});
			else if (instance.ownerGroup != null)
				return String.format(org.zkoss.util.resource.Labels.getLabel("accounts.fromGroup"),
					new Object[]{instance.ownerGroup});
			else if (instance.ownerRolName != null)
				return String.format(org.zkoss.util.resource.Labels.getLabel("accounts.fromRol"),
					new Object[] {instance.ownerRolName, instance.ownerDispatcher});
			else
				return "???";
		</custom-attribute>
	</datanode>
	
	<datanode name="tipusUsuari" />
 	
	<datanode name="attribute">
		<script-handler>
			<insert-script>
				instance.accountName = parent.instance.name;
				instance.systemName = parent.instance.dispatcher;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:comp/env/ejb/AccountEJB">
			<insert-method method="createAccountAttribute" returnBean="true" > <!-- user:role:create -->
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="deleteAccountAttribute" >  <!-- user:role:delete -->
				<parameter value="${instance}" />
			</delete-method>
			<update-method method="updateAccountAttribute">  
				<parameter value="${instance}" />
			</update-method>
		</ejb-handler>
	</datanode>

</zkib-model>
