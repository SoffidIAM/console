<?xml version="1.0" encoding="UTF-8"?>

<zkib-model>
	<datanode name="agents">
		<finder name="customObjectType" type="objectType">
			<ejb-finder jndi="java:/module/AdditionalDataService-v2" method="findCustomObjectTypeByJsonQuery">
				<parameter value=""/>
			</ejb-finder>
		</finder>
		<finder name="attributeDirection" type="attributeDirection">
			<script-finder>
				import es.caib.seycon.ng.comu.*;
				list = new java.util.LinkedList();
				list.add (new String(""));
				for (l: AttributeDirection.literals())
				{
					list.add (l);
				}
				return list;
			</script-finder>
		</finder>
		<finder name="soffidObjectTypeTrigger" type="soffidObjectType">
			<script-finder>
				import es.caib.seycon.ng.comu.*;
				list = new java.util.LinkedList();
				list.add (new String(""));
				list.add (com.soffid.iam.api.SoffidObjectType.OBJECT_USER.toString());
				list.add (com.soffid.iam.api.SoffidObjectType.OBJECT_ACCOUNT.toString());
				list.add (com.soffid.iam.api.SoffidObjectType.OBJECT_GROUP.toString());
				list.add (com.soffid.iam.api.SoffidObjectType.OBJECT_ROLE.toString());
				list.add (com.soffid.iam.api.SoffidObjectType.OBJECT_GRANT.toString());
				return list;
			</script-finder>
		</finder>

		<finder name="soffidObjectTrigger" type="soffidObjectTrigger">
			<script-finder>
				import es.caib.seycon.ng.comu.*;
				list = new java.util.LinkedList();
				list.add (new String(""));
				for (l: SoffidObjectTrigger.literals())
				{
					list.add (l);
				}
				return list;
			</script-finder>
		</finder>
		<finder name="agent" type="agent">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
					method="findSystemByTextAndJsonQueryAsync" if="${query != null || text != null}">
				<parameter value="${text}"/>
				<parameter value="${query}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.System">
				<bean-attribute name="readOnly" value="true"/>
				<bean-attribute name="manualAccountCreation" value="true"/>
			</new-instance-bean>
		</finder>
		<finder name="plugin" type="plugin">
			<script-finder>
				sp = new com.soffid.iam.api.AgentDescriptor();
				sp.id = 0L;
				sp.setClassName("- no class -");
				sp.setDescription("-");
				return sp;
			</script-finder>
			<ejb-finder jndi="java:/module/ServerPluginService-v2"
				method="getAgentDescriptors">  <!--agent:query-->
			</ejb-finder>
		</finder>
		<finder name="dominisUsuari" type="dominiUsuari">
			<script-finder>
			   v = new Vector();
			   obj = new com.soffid.iam.api.UserDomain();
			   obj.setCode ("");
			   obj.setDescription (org.zkoss.util.resource.Labels.getLabel("descriptorAgent.Select"));
			   v.add(obj);
			   return obj;
			</script-finder>
			<ejb-finder jndi="java:/module/UserDomainService-v2"
				method="findAllUserDomain">  <!-- ?? -->
			</ejb-finder>
		</finder>
		<finder name="tipusUsuari" type="tipusUsuari">
			<ejb-finder jndi="java:/module/UserDomainService-v2"
				method="findAllUserType">  <!-- ?? -->
			</ejb-finder>
		</finder>		
		<finder name="dominisContrasenya" type="dominisContrasenya">
			<script-finder>
			   v = new Vector();
			   obj = new com.soffid.iam.api.PasswordDomain();
			   obj.setCode ("");
			   obj.setDescription (org.zkoss.util.resource.Labels.getLabel("descriptorAgent.Select"));
			   v.add(obj);
			   return obj;
			</script-finder>
			<ejb-finder jndi="java:/module/UserDomainService-v2"
				method="findAllPasswordDomain"> 
			</ejb-finder>
		</finder>
		<finder name="server" type="server">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findAllServers"> <!--agent:query, application:update-->
			</ejb-finder>
		</finder>
		<finder name="serverSelector" type="server">
			<script-finder>
				v = new java.util.Vector();
				obj = new com.soffid.iam.api.Server();
				obj.setUrl(null);
				obj.setName(org.zkoss.util.resource.Labels.getLabel("agents.disabled"));
				v.add (obj);
				obj = new com.soffid.iam.api.Server();
				obj.setUrl("local");
				obj.setName(org.zkoss.util.resource.Labels.getLabel("agents.local"));
				v.add (obj);
				return v;				
			</script-finder>
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findAllServers"> <!--agent:query, application:update-->
			</ejb-finder>
		</finder>
		<finder name="serverSelector2" type="server">
			<script-finder>
				v = new java.util.Vector();
				obj = new com.soffid.iam.api.Server();
				obj.setUrl(null);
				obj.setName("");
				v.add (obj);
				obj = new com.soffid.iam.api.Server();
				obj.setUrl("local");
				obj.setName(org.zkoss.util.resource.Labels.getLabel("agents.local"));
				v.add (obj);
				return v;				
			</script-finder>
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findAllServers"> <!--agent:query, application:update-->
			</ejb-finder>
		</finder>
		<finder name="servertype" type="servertype">
			<script-finder>
				v = new java.util.Vector();
				if (com.soffid.iam.utils.Security.isUserInRole("server:manage:server"))
				{
					obj = new es.caib.seycon.ng.web.PairContainer();
					obj.setFirst(org.zkoss.util.resource.Labels.getLabel("servers.zul.server"));
					obj.setSecond(es.caib.seycon.ng.comu.ServerType.MASTERSERVER);
					v.add (obj);
				}
				if (com.soffid.iam.utils.Security.isUserInRole("server:manage:proxy"))
				{
					obj = new es.caib.seycon.ng.web.PairContainer();
					obj.setFirst(org.zkoss.util.resource.Labels.getLabel("servers.zul.agent"));
					obj.setSecond(es.caib.seycon.ng.comu.ServerType.PROXYSERVER);
					v.add(obj);
					obj = new es.caib.seycon.ng.web.PairContainer();
					obj.setFirst(org.zkoss.util.resource.Labels.getLabel("servers.zul.gateway"));
					obj.setSecond(es.caib.seycon.ng.comu.ServerType.GATEWAY);
					v.add(obj);
					obj = new es.caib.seycon.ng.web.PairContainer();
					obj.setFirst(org.zkoss.util.resource.Labels.getLabel("servers.zul.remote"));
					obj.setSecond(es.caib.seycon.ng.comu.ServerType.REMOTESERVER);
					v.add(obj);
				}
				return v;				
			</script-finder>
		</finder>
		<finder name="authoritativeProcess" type="authoritativeProcess">
			<script-finder>
				engine = com.soffid.iam.EJBLocator.getBpmEngine();
				java.util.LinkedList list = new java.util.LinkedList ();
				tv = new es.caib.seycon.ng.web.utils.TagValueEntry ();
				tv.setTag ("-");
				tv.setValue(null);
				list.add (tv);
				for (def: engine.findProcessDefinitions (null, es.caib.bpm.vo.PredefinedProcessType.AUTHORITATIVE_CHANGE))
				{
					tv = new es.caib.seycon.ng.web.utils.TagValueEntry ();
					tv.setTag (def.name);
					tv.setValue(def.name);
				
					list.add (tv);
				}
				return list;
			</script-finder>
		</finder>
		<finder name="dataType" type="dataType">
			<script-finder>
				import es.caib.seycon.ng.comu.*;
				list = new java.util.LinkedList();
				list.add (new String(""));
				for (l: TypeEnumeration.literals())
				{
					list.add (l);
				}
				return list;
			</script-finder>
		</finder>
		<finder name="visibility" type="visibility">
			<script-finder>
				import com.soffid.iam.api.*;
				list = new java.util.LinkedList();
				list.add (new String(""));
				for (l: AttributeVisibilityEnum.literals())
				{
					list.add (l);
				}
				return list;
			</script-finder>
		</finder>
	</datanode>

	<datanode name="objectType" transient="true"/>


	<datanode name="authoritativeProcess"></datanode>	
	
	<datanode name="servertype"/>
	
	<datanode name="dominiUsuari"/>
	
	<datanode name="dominisContrasenya"/>
	
	<datanode name="tipusUsuari"/>
	
	<datanode name="server">
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>

	<datanode name="agent">
		<finder name="controlAcces" type="controlAcces">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="getAccessControl">  <!--agent:query-->
				<parameter value="${instance}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.AccessControl">
			</new-instance-bean>
		</finder>	

		<finder name="objectMapping" type="objectMapping" refreshAfterCommit="false">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findObjectMappingsByDispatcher"> 
				<parameter value="${instance.id}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.ObjectMapping">
				<bean-attribute name="soffidObject" value="${com.soffid.iam.api.SoffidObjectType.OBJECT_ACCOUNT}"></bean-attribute>
			</new-instance-bean>
		</finder>	

		<finder name="reconcileTrigger" type="reconcileTrigger" refreshAfterCommit="true">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findReconcileTriggersByDispatcher"> 
				<parameter value="${instance.id}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.ReconcileTrigger">
				<bean-attribute name="objectType" value="${com.soffid.iam.api.SoffidObjectType.OBJECT_ACCOUNT}"></bean-attribute>
				<bean-attribute name="trigger" value="${es.caib.seycon.ng.comu.SoffidObjectTrigger.PRE_INSERT}"></bean-attribute>
			</new-instance-bean>
		</finder>	


		<finder name="metadata" type="metadata">
			<ejb-finder jndi="java:/module/AdditionalDataService-v2"
				method="findSystemDataTypes">  <!--agent:query-->
				<parameter value="${instance.name}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.DataType">
			</new-instance-bean>
		</finder>	

		<finder name="tasks" type="tasks">
			<script-finder>
				return com.soffid.iam.web.agent.AgentTasksStatusHelper.getStatus(instance.name);
			</script-finder>
		</finder>	

		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
		
		
		<validator>
			<attribute-validator expr="${instance.name}" notNull="true" friendlyName="agents.DispatcherCodiValidation"/>
			<attribute-validator expr="${instance.passwordsDomain}" notNull="true" friendlyName="agents.DominiContrasenyaValidation"/>
			<attribute-validator expr="${instance.usersDomain}" notNull="true" friendlyName="agents.DominiUsuariValidation"/>	 		
		</validator>


		<finder name="updateStatus" type="updateStatus">
			<script-finder>
				return new java.util.LinkedList();
			</script-finder>
			<new-instance-bean
				className="com.soffid.iam.api.AsyncProcessTracker">
			</new-instance-bean>
		</finder>
	</datanode>

	<datanode name="updateStatus" transient="true" />

	<datanode name="tasks" transient="true" />

	<datanode name="metadata">
		<script-handler>
			<insert-script>
				instance.setSystemName(parent.getInstance().getName());
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/AdditionalDataService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}" />
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}" />
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}" />
			</update-method>
		</ejb-handler>
		<validator>
			<attribute-validator expr="${instance.order}" notNull="true" friendlyName="dadesAddicionals.OrdreValidation"/>
			<attribute-validator expr="${instance.name}" notNull="true" friendlyName="dadesAddicionals.CodiValidation"/>
		</validator>
	</datanode>

	<datanode name="controlAcces">
		<script-handler>
			<insert-script>
				instance.agentId=parent.instance.id;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="attributeMapping">
		<script-handler>
			<insert-script>
				instance.objectId=parent.instance.id;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="objectMappingTrigger">
		<script-handler>
			<insert-script>
				instance.objectId=parent.instance.id;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="reconcileTrigger">
		<script-handler>
			<insert-script>
				instance.system=parent.instance.name;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="objectMapping">
		<finder name="property" type="objectProperty" refreshAfterCommit="true">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findObjectMappingPropertiesByObject"> 
				<parameter value="${instance.id}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.ObjectMappingProperty">
			</new-instance-bean>
		</finder>	

		<finder name="objectMappingTrigger" type="objectMappingTrigger" refreshAfterCommit="true">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findObjectMappingTriggersByObject"> 
				<parameter value="${instance.id}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.ObjectMappingTrigger">
			</new-instance-bean>
		</finder>	

		<finder name="attributeMapping" type="attributeMapping" refreshAfterCommit="true">
			<ejb-finder jndi="java:/module/DispatcherService-v2"
				method="findAttributeMappingsByObject"> 
				<parameter value="${instance.id}"/>
			</ejb-finder>
			<new-instance-bean
				className="com.soffid.iam.api.AttributeMapping">
				<bean-attribute name="direction" value="${es.caib.seycon.ng.comu.AttributeDirection.INPUT}"></bean-attribute>
			</new-instance-bean>
		</finder>	

		<script-handler>
			<insert-script>
				instance.dispatcherId=parent.instance.id;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="objectProperty">
		<script-handler>
			<insert-script>
				instance.objectId=parent.instance.id;
			</insert-script>
		</script-handler>
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}"/>
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}"/>
			</delete-method>
			<update-method method="update">
				<parameter value="${instance}"/>
			</update-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="plugin" transient="true">
		<finder name="pluginWorkflow" type="pluginWorkflow">
			<ejb-finder jndi="java:/module/ServerPluginService-v2"
					method="findAgentDescriptorWorkflows" if=${instance.id != null}"> 
				<parameter value="${instance}"/>
			</ejb-finder>
		</finder>
	</datanode>
	
	<datanode name="pluginWorkflow" transient="true"/>
	
	<datanode name="grupsAgent">
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}" />
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}" />
			</delete-method>
		</ejb-handler>
	</datanode>

	<datanode name="tipusUsuariAgent">
		<ejb-handler jndi="java:/module/DispatcherService-v2">
			<insert-method method="create" returnBean="true">
				<parameter value="${instance}" />
			</insert-method>
			<delete-method method="delete">
				<parameter value="${instance}" />
			</delete-method>
		</ejb-handler>
	</datanode>
	
	<datanode name="attributeDirection" transient="true">
		<custom-attribute name="literal">
			if (instance.length() == 0)
				return "";
			else
				return org.zkoss.util.resource.Labels.getLabel("attributeDirection."+instance);
		</custom-attribute>
		<custom-attribute name="value">
			if (instance.length() == 0)
				return null;
			else
				return es.caib.seycon.ng.comu.AttributeDirection.fromString(instance);
		</custom-attribute>

	</datanode>

	<datanode name="soffidObjectType" transient="true">
		<custom-attribute name="literal">
			if (instance.length() == 0)
				return "- select one -";
			else
				return instance;
		</custom-attribute>
		<custom-attribute name="value">
			if (instance.length() == 0)
				return null;
			else
				return com.soffid.iam.api.SoffidObjectType.fromString(instance);
		</custom-attribute>

	</datanode>

	<datanode name="soffidObjectTrigger" transient="true">
		<custom-attribute name="literal">
			if (instance.length() == 0)
				return "- select one -";
			else
				return instance;
		</custom-attribute>
		<custom-attribute name="value">
			if (instance.length() == 0)
				return null;
			else
				return es.caib.seycon.ng.comu.SoffidObjectTrigger.fromString(instance);
		</custom-attribute>

	</datanode>

	<datanode name="dataType" transient="true">
		<custom-attribute name="literal">
			if (instance.length() == 0)
				return "";
			else
			 	return org.zkoss.util.resource.Labels.getLabel("typeDadaAddicional."+instance);
		</custom-attribute>
		<custom-attribute name="value">
			if (instance.length() == 0)
				return null;
			else
				return es.caib.seycon.ng.comu.TypeEnumeration.fromString(instance);
		</custom-attribute>
	</datanode>
	
	<datanode name="visibility" transient="true">
		<custom-attribute name="literal">
			if (instance.length() == 0)
				return "";
			else
			 	return org.zkoss.util.resource.Labels.getLabel("attributeVisibility."+instance);
		</custom-attribute>
		<custom-attribute name="value">
			if (instance.length() == 0)
				return null;
			else
				return com.soffid.iam.api.AttributeVisibilityEnum.fromString(instance);
		</custom-attribute>
	</datanode>

</zkib-model>
