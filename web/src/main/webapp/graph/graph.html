<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<header>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
	<script >

	Chart.register(ChartDataLabels);

	Chart.register({
		id: "centerLabel",
		beforeDraw: function (chart) {
		    if (chart.config.options.elements && chart.config.options.elements.center) {
		      //Get ctx from string
		      var ctx = chart.ctx;

		      //Get options from the center object in options
		      var centerConfig = chart.config.options.elements.center;
		      var fontStyle = centerConfig.fontStyle || 'Arial';
		      var txt = centerConfig.text;
		      var color = centerConfig.color || '#000';
		      var sidePadding = centerConfig.sidePadding || 20;
		      var sidePaddingCalculated = (sidePadding/100) * (chart.innerRadius * 2)
		      //Start with a base font of 30px
		      ctx.font = "30px " + fontStyle;

		      //Get the width of the string and also the width of the element minus 10 to give it 5px side padding
		      var stringWidth = ctx.measureText(txt).width;
		      var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;

		      // Find out how much the font can grow in width.
		      var widthRatio = elementWidth / stringWidth;
		      var newFontSize = Math.floor(30 * widthRatio);
		      var elementHeight = (chart.innerRadius * 2);

		      // Pick a new font size so it will not be larger than the height of label.
		      var fontSizeToUse = Math.min(newFontSize, elementHeight);

		      //Set font settings to draw it correctly.
		      ctx.textAlign = 'center';
		      ctx.textBaseline = 'middle';
		      var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
		      var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
		      ctx.font = fontSizeToUse+"px " + fontStyle;
		      ctx.fillStyle = color;

		      //Draw text in center
		      ctx.fillText(txt, centerX, centerY);
		    }
		  }
		});

	var myChart = null;
	var myData = null;
	
	
	
	
	async function loadData () 
    {
		var url = document.location.href;
		var i  = url.indexOf("?data=");
		var dataPath = url.substring(i+6);
        const response = await fetch("./"+dataPath, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });
        myData = await response.json();
        if (myData.options && myData.options.scales && 
        		myData.options.scales.yAxes &&
        		myData.options.scales.yAxes[0] &&
        		myData.options.scales.yAxes[0].ticks &&
        		myData.options.scales.yAxes[0].ticks.callback &&
        		myData.options.scales.yAxes[0].ticks.callback == "locale")
      		{
        	myData.options.scales.yAxes[0].ticks.callback = 
   	   			function(value, index, values) {
						return value.toLocaleString(); 
				};
      		}
        var chart = document.getElementById('myChart');
		var ctx = chart.getContext('2d');

		if (myChart) {
			if (myData.data.datasets.length == myChart.data.datasets.length) {
				if (myData.data.labels) myChart.data.labels = myData.data.labels;
				for (var i = 0; i < myData.data.datasets.length; i++)
					myChart.data.datasets[i].data = myData.data.datasets[i].data;
			} else {
				myChart.data = myData.data;				
			}
			myChart.options = myData.options;
			myChart.update();
		} else {
			chart.style.width="90vw";
			chart.style.height="90vh";
			chart.width = chart.offsetWidth;
			chart.height = chart.offsetHeight;
			myChart = new Chart(ctx, myData);
			chart.width = chart.offsetWidth;
			chart.height = chart.offsetHeight;
    	}
		if ( myData.refresh) {
			setTimeout ( loadData, myData.refresh );
		}
        return myData;
    }

	window.addEventListener("resize", (event) => {
		if (myData != null) {
	        var chart = document.getElementById('myChart');
			chart.style.width="90vw";
			chart.style.height="90vh";
			chart.width = chart.offsetWidth;
			chart.height = chart.offsetHeight;
			var ctx = chart.getContext('2d');
			if (myChart != null) myChart.destroy();
			myChart = new Chart(ctx, myData);
//			chart.width = chart.offsetWidth;
//			chart.height = chart.offsetHeight;
		}
	});
	</script>
</header>
<body onLoad="loadData()" style="overflow: hidden ">
	<canvas id="myChart" style="height: 90vh; width: 90vw"></canvas>
</body>
</html>
